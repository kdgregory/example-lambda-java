AWSTemplateFormatVersion:               "2010-09-09"
Description:                            "Sample Lambda web application programmed in Java"

Parameters:

  BaseName:
    Description:                        "Base name for all objects created by this template"
    Type:                               "String"

  VpcId:
    Description:                        "The VPC where the load balancer will be deployed"
    Type:                               "AWS::EC2::VPC::Id"

  PublicSubnetIds:
    Description:                        "The list of public subnets where load balancer endpoints will live"
    Type:                               "List<AWS::EC2::Subnet::Id>"

  Bucket:
    Description:                        "Name of the bucket used by the application"
    Type:                               "String"

  LogsPrefix:
    Description:                        "Prefix for load-balancer logs within the application bucket"
    Type:                               "String"
    Default:                            "lb-logs"

  WebappJar:
    Description:                        "Bucket key for the WebApp deployment JAR"
    Type:                               "String"

  ResizerJar:
    Description:                        "Bucket key for the Resizer deployment JAR"
    Type:                               "String"

Resources:

  ##
  ## Ungrouped Resources
  ##

  CognitoUserPool:
    Type:                               "AWS::Cognito::UserPool"
    Properties:
      UserPoolName:                     !Sub "${BaseName}-UserPool"
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly:       true
        UnusedAccountValidityDays:      7
      MfaConfiguration:                 "OFF"
      Policies:
        PasswordPolicy:
          MinimumLength:                8
          RequireUppercase:             true
          RequireLowercase:             true
          RequireNumbers:               true
          RequireSymbols:               false
      Schema:
        -
          Name:                         "email"
          Required:                     true
          Mutable:                      true
          DeveloperOnlyAttribute:       false
          AttributeDataType:            "String"
          StringAttributeConstraints:
            MinLength:                  0
            MaxLength:                  2048
        -
          Name:                         "email_verified"
          Required:                     false
          Mutable:                      true
          DeveloperOnlyAttribute:       false
          AttributeDataType:            "Boolean"

  CognitoUserPoolClient:
    Type:                               "AWS::Cognito::UserPoolClient"
    Properties:
      UserPoolId:                       !Ref CognitoUserPool
      ClientName:                       "default"
      ExplicitAuthFlows:                [ "ADMIN_NO_SRP_AUTH" ]
      GenerateSecret:                   false
      RefreshTokenValidity:             7

  DynamoMetadataTable:
    Type:                               "AWS::DynamoDB::Table"
    Properties:
      TableName:                        !Sub "${BaseName}-Metadata"
      AttributeDefinitions:
        -
          AttributeName:                "username"
          AttributeType:                "S"
        -
          AttributeName:                "id"
          AttributeType:                "S"
      KeySchema:
        -
          AttributeName:                "username"
          KeyType:                      "HASH"
        -
          AttributeName:                "id"
          KeyType:                      "RANGE"
      ProvisionedThroughput:
        ReadCapacityUnits:              10
        WriteCapacityUnits:             5

  ##
  ## Resizer
  ##

  ResizerLogGroup:
    Type:                               "AWS::Logs::LogGroup"
    DeletionPolicy:                     "Delete"
    Properties:
      LogGroupName:                     !Sub "/aws/lambda/${BaseName}-Resizer"
      RetentionInDays:                  7

  ResizerExecutionRole:
    Type:                               "AWS::IAM::Role"
    DependsOn:                          [ DynamoMetadataTable, ResizerLogGroup ]
    Properties:
      RoleName:                         !Sub "${BaseName}-ResizerExecutionRole"
      AssumeRolePolicyDocument:
        Version:                        "2012-10-17"
        Statement:
          Effect:                       "Allow"
          Action:                       "sts:AssumeRole"
          Principal:
            Service:                    "lambda.amazonaws.com"
      Policies:
        -
          PolicyName:                   !Sub "${BaseName}-ResizerCloudWatchPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              -
                Effect:                 "Allow"
                Action:
                  -                     "logs:CreateLogGroup"
                Resource:               "*"
              -
                Effect:                 "Allow"
                Action:
                  -                     "logs:CreateLogStream"
                  -                     "logs:PutLogEvents"
                Resource:               !GetAtt ResizerLogGroup.Arn
        -
          PolicyName:                   !Sub "${BaseName}-ResizerDynamoPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              Effect:                   "Allow"
              Action:
                -                       "dynamodb:GetItem"
                -                       "dynamodb:PutItem"
                -                       "dynamodb:Query"
              Resource:                 !GetAtt DynamoMetadataTable.Arn
        -
          PolicyName:                   !Sub "${BaseName}-ResizerBucketPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              Effect:                   "Allow"
              Action:
                -                       "s3:Get*"
                -                       "s3:Put*"
              Resource:                 !Sub "arn:aws:s3:::${Bucket}/images/*"

  ResizerLambdaFunction:
    Type:                               "AWS::Lambda::Function"
    DependsOn:                          [ ResizerExecutionRole ]
    Properties:
      Description:                      "Implements the resizer portion of the example"
      Runtime:                          "java8"
      FunctionName:                     !Sub "${BaseName}-Resizer"
      Code:
        S3Bucket:                       !Ref Bucket
        S3Key:                          !Ref ResizerJar

      Role:                             !GetAtt ResizerExecutionRole.Arn
      Handler:                          "com.kdgregory.example.javalambda.resizer.Resizer::handler"
      MemorySize:                       256
      Timeout:                          30
      Environment:
        Variables:
          DYNAMO_TABLE:                 !Ref DynamoMetadataTable
          S3_IMAGE_BUCKET:              !Ref Bucket
          S3_IMAGE_PREFIX:              "images"

  ResizeNotificationTopic:
    Type:                               "AWS::SNS::Topic"
    Properties:
      TopicName:                        !Sub "${BaseName}-Notifications"
      DisplayName:                      !Sub "Used by the ${BaseName} example to notify the resizer of new images"

  ResizerSubscription:
    Type:                               "AWS::SNS::Subscription"
    DependsOn:                          [ ResizerLambdaFunction, ResizeNotificationTopic ]
    Properties:
      Protocol:                         "lambda"
      Endpoint:                         !GetAtt ResizerLambdaFunction.Arn
      TopicArn:                         !Ref ResizeNotificationTopic

  ResizerInvocationPermission:
    Type:                               "AWS::Lambda::Permission"
    Properties:
      Action:                           "lambda:InvokeFunction"
      FunctionName:                     !GetAtt ResizerLambdaFunction.Arn
      Principal:                        "sns.amazonaws.com"
      SourceArn:                        !Ref ResizeNotificationTopic

  ##
  ## WebApp Lambda
  ##

  WebappLogGroup:
    Type:                               "AWS::Logs::LogGroup"
    DeletionPolicy:                     "Delete"
    Properties:
      LogGroupName:                     !Sub "/aws/lambda/${BaseName}-Webapp"
      RetentionInDays:                  7

  WebappExecutionRole:
    Type:                               "AWS::IAM::Role"
    DependsOn:                          [ CognitoUserPool, DynamoMetadataTable, ResizeNotificationTopic, WebappLogGroup ]
    Properties:
      RoleName:                         !Sub "${BaseName}-WebappExecutionRole"
      AssumeRolePolicyDocument:
        Version:                        "2012-10-17"
        Statement:
          Effect:                       "Allow"
          Action:                       "sts:AssumeRole"
          Principal:
            Service:                    "lambda.amazonaws.com"
      Policies:
        -
          PolicyName:                   !Sub "${BaseName}-WebappCloudWatchPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              -
                Effect:                 "Allow"
                Action:
                  -                     "logs:CreateLogGroup"
                Resource:               "*"
              -
                Effect:                 "Allow"
                Action:
                  -                     "logs:CreateLogStream"
                  -                     "logs:PutLogEvents"
                Resource:               !GetAtt WebappLogGroup.Arn
        -
          PolicyName:                   !Sub "${BaseName}-WebappCognitoPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              -
                Effect:                 "Allow"
                Action:
                  -                     "cognito-idp:*"
                Resource:               !GetAtt CognitoUserPool.Arn
        -
          PolicyName:                   !Sub "${BaseName}-WebappDynamoPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              -
                Effect:                 "Allow"
                Action:
                  -                     "dynamodb:GetItem"
                  -                     "dynamodb:PutItem"
                  -                     "dynamodb:Query"
                Resource:               !GetAtt DynamoMetadataTable.Arn
        -
          PolicyName:                   !Sub "${BaseName}-WebappSNSPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              -
                Effect:                 "Allow"
                Action:                 "sns:Publish"
                Resource:               !Ref ResizeNotificationTopic
        -
          PolicyName:                   !Sub "${BaseName}-WebappBucketPolicy"
          PolicyDocument:
            Version:                    "2012-10-17"
            Statement:
              -
                Effect:                 "Allow"
                Action:                 "s3:List*"
                Resource:               !Sub "arn:aws:s3:::${Bucket}"
              -
                Effect:                 "Allow"
                Action:
                  -                     "s3:Get*"
                  -                     "s3:Put*"
                Resource:               !Sub "arn:aws:s3:::${Bucket}/images/*"

  WebappLambdaFunction:
    Type:                               "AWS::Lambda::Function"
    DependsOn:                          [ WebappExecutionRole ]
    Properties:
      Description:                      "Implements the web-app portion of the example"
      Runtime:                          "java8"
      FunctionName:                     !Sub "${BaseName}-Webapp"
      Code:
        S3Bucket:                       !Ref Bucket
        S3Key:                          !Ref WebappJar

      Role:                             !GetAtt WebappExecutionRole.Arn
      Handler:                          "com.kdgregory.example.javalambda.webapp.Dispatcher::handler"
      MemorySize:                       256
      Timeout:                          30
      Environment:
        Variables:
          COGNITO_POOL_ID:              !Ref CognitoUserPool
          COGNITO_CLIENT_ID:            !Ref CognitoUserPoolClient
          DYNAMO_TABLE:                 !Ref DynamoMetadataTable
          SNS_TOPIC_ARN:                !Ref ResizeNotificationTopic
          S3_IMAGE_BUCKET:              !Ref Bucket
          S3_IMAGE_PREFIX:              "images"

  ##
  ## Front-End
  ##

  LoadBalancerSecurityGroup:
    Type:                               "AWS::EC2::SecurityGroup"
    Properties: 
      GroupName:                        !Sub "${BaseName}-SecurityGroup"
      GroupDescription:                 !Sub "Provides Internet access to the ${BaseName} load balancer"
      VpcId:                            !Ref VpcId
      SecurityGroupIngress: 
        -
          Description:                  "HTTP access from Internet"
          CidrIp:                       "0.0.0.0/0"
          IpProtocol:                   "tcp"
          FromPort:                     80
          ToPort:                       80

  LoadBalancer:
    Type:                               "AWS::ElasticLoadBalancingV2::LoadBalancer"
    Properties: 
      Name:                             !Sub "${BaseName}-API"
      Type:                             "application"
      Scheme:                           "internet-facing"
      IpAddressType:                    "ipv4"
      SecurityGroups:                   [ !Ref LoadBalancerSecurityGroup ]
      Subnets:                          !Ref PublicSubnetIds
      LoadBalancerAttributes:
        -                               { 'Key': 'access_logs.s3.enabled',  'Value': true }
        -                               { 'Key': 'access_logs.s3.bucket',   'Value': !Ref Bucket }
        -                               { 'Key': 'access_logs.s3.prefix',   'Value': !Ref LogsPrefix }

  LoadBalancerHTTPListener:
    Type:                               "AWS::ElasticLoadBalancingV2::Listener"
    DependsOn:                          [ LoadBalancerTargetGroup ]
    Properties: 
      Protocol:                         "HTTP"
      Port:                             80
      LoadBalancerArn:                  !Ref LoadBalancer
      DefaultActions: 
        -
          Type:                         "fixed-response"
          FixedResponseConfig:
            StatusCode:                 404
            ContentType:                "text/plain"
            MessageBody:                "invalid destination"

  LoadBalancerAPIDispatchRule:
    Type:                               "AWS::ElasticLoadBalancingV2::ListenerRule"
    Properties: 
      ListenerArn:                      !Ref LoadBalancerHTTPListener
      Priority:                         10
      Conditions: 
        -
          Field:                        "path-pattern"
          Values:
            -                           "/api/*"
      Actions: 
        -
          Type:                         "forward"
          TargetGroupArn:               !Ref LoadBalancerTargetGroup

  LoadBalancerTargetGroup:
    Type:                               "AWS::ElasticLoadBalancingV2::TargetGroup"
    DependsOn:                          [ LoadBalancerInvocationPermission ]
    Properties: 
      Name:                             !Sub "${BaseName}-LambdaTarget"
      TargetType:                       "lambda"
      HealthCheckEnabled:               false
      Targets:
        -
          Id:                           !GetAtt WebappLambdaFunction.Arn

  LoadBalancerInvocationPermission:
    Type:                               "AWS::Lambda::Permission"
    Properties: 
      Action:                           "lambda:InvokeFunction"
      FunctionName:                     !Ref WebappLambdaFunction
      Principal:                        "elasticloadbalancing.amazonaws.com"

  CloudFrontOriginIdentity:
    Type:                               "AWS::CloudFront::CloudFrontOriginAccessIdentity"
    Properties: 
      CloudFrontOriginAccessIdentityConfig: 
        Comment:                        !Sub "Origin identity for ${BaseName} deployment"

  CloudFront:
    Type:                               "AWS::CloudFront::Distribution"
    Properties: 
      DistributionConfig: 
        Comment:                        !Sub "${BaseName} deployment"
        Enabled:                        true
        DefaultRootObject:              "index.html"
        Origins: 
          -
            Id:                         "StaticContent"
            DomainName:                 !Sub "${Bucket}.s3.amazonaws.com"
            OriginPath:                 "/static"
            S3OriginConfig:
              OriginAccessIdentity:     !Sub "origin-access-identity/cloudfront/${CloudFrontOriginIdentity}"
          -
            Id:                         "Images"
            DomainName:                 !Sub "${Bucket}.s3.amazonaws.com"
            S3OriginConfig:
              OriginAccessIdentity:     !Sub "origin-access-identity/cloudfront/${CloudFrontOriginIdentity}"
          -
            Id:                         "API"
            DomainName:                 !GetAtt LoadBalancer.DNSName
            CustomOriginConfig: 
              HTTPPort:                 80
              OriginProtocolPolicy:     "http-only"
          -
            Id:                         "BlackHole"
            DomainName:                 !GetAtt LoadBalancer.DNSName
            OriginPath:                 "/blackhole"        # this path won't match accidentally
            CustomOriginConfig: 
              HTTPPort:                 80
              OriginProtocolPolicy:     "http-only"
        CacheBehaviors: 
          -
            PathPattern:                "/api/*"
            ViewerProtocolPolicy:       "redirect-to-https"
            TargetOriginId:             "API"
            AllowedMethods:             [ "GET", "HEAD", "OPTIONS", "PUT", "PATCH", "POST", "DELETE" ]
            CachedMethods:              [ "GET", "HEAD" ]   # would be nice to have "none"
            ForwardedValues: 
              Cookies: 
                Forward:                "all"
              QueryString:              true
            Compress:                   false               # wouldn't buy much
            DefaultTTL:                 0                   # in case we don't have cache-control headers
          -
            PathPattern:                "/images/*"
            ViewerProtocolPolicy:       "redirect-to-https"
            TargetOriginId:             "Images"
            AllowedMethods:             [ "GET", "HEAD" ]
            CachedMethods:              [ "GET", "HEAD" ]
            ForwardedValues: 
              QueryString:              false
            Compress:                   false
            DefaultTTL:                 86400
          -
            PathPattern:                "index.html"
            ViewerProtocolPolicy:       "redirect-to-https"
            TargetOriginId:             "StaticContent"
            AllowedMethods:             [ "GET", "HEAD" ]
            CachedMethods:              [ "GET", "HEAD" ]
            ForwardedValues: 
              QueryString:              false
            Compress:                   true
            DefaultTTL:                 86400
          -
            PathPattern:                "/templates/*"
            ViewerProtocolPolicy:       "redirect-to-https"
            TargetOriginId:             "StaticContent"
            AllowedMethods:             [ "GET", "HEAD" ]
            CachedMethods:              [ "GET", "HEAD" ]
            ForwardedValues: 
              QueryString:              false
            Compress:                   true
            DefaultTTL:                 86400
          -
            PathPattern:                "/css/*"
            ViewerProtocolPolicy:       "redirect-to-https"
            TargetOriginId:             "StaticContent"
            AllowedMethods:             [ "GET", "HEAD" ]
            CachedMethods:              [ "GET", "HEAD" ]
            ForwardedValues: 
              QueryString:              false
            Compress:                   true
            DefaultTTL:                 86400
          -
            PathPattern:                "/js/*"
            ViewerProtocolPolicy:       "redirect-to-https"
            TargetOriginId:             "StaticContent"
            AllowedMethods:             [ "GET", "HEAD" ]
            CachedMethods:              [ "GET", "HEAD" ]
            ForwardedValues: 
              QueryString:              false
            Compress:                   true
            DefaultTTL:                 86400
        DefaultCacheBehavior:
            ViewerProtocolPolicy:       "redirect-to-https"
            TargetOriginId:             "BlackHole"
            AllowedMethods:             [ "GET", "HEAD" ]
            CachedMethods:              [ "GET", "HEAD" ]
            ForwardedValues: 
              QueryString:              false
            Compress:                   false
            DefaultTTL:                 86400
            ForwardedValues: 
              QueryString:              false

Outputs:

  CognitoUserPoolOutput:
    Description:                      "Cognito pool for application users"
    Value:                            !Ref CognitoUserPool

  CognitoUserPoolClientOutput:
    Description:                      "Cognito client for application users"
    Value:                            !Ref CognitoUserPoolClient

  DynamoMetadataTableOutput:
    Description:                      "DynamoDB table holding photo metadata"
    Value:                            !Ref DynamoMetadataTable

  ResizeNotificationTopicOutput:
    Description:                      "SNS topic used to notify the resizer of new images"
    Value:                            !Ref ResizeNotificationTopic

  WebappLambdaFunctionOutput:
    Description:                      "Lambda function implementing the web-app"
    Value:                            !Ref WebappLambdaFunction

  WebappLogGroupOutput:
    Description:                      "CloudWatch log group for the web-app lambda function"
    Value:                            !Ref WebappLogGroup

  ResizerLambdaFunctionOutput:
    Description:                      "Lambda function implementing the resizer"
    Value:                            !Ref ResizerLambdaFunction

  ResizerLogGroupOutput:
    Description:                      "CloudWatch log group for the resizer lambda function"
    Value:                            !Ref ResizerLogGroup
